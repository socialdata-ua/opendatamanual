
## Оптимізація структури даних

Досить часто дані, що здаються зручно і прозоро впорядкованими,
потребують докорінної *структурної* реорганізації.
Не будь-яка людиночитабельна таблиця є добре машинооброблюваною.
Можна сказати навіть, що таблиця, орієнтована на людське сприйняття
є скоріше способом представлення даних,
ніж охайно впорядкованим набором даних.

Машина — ретельний і сумлінний, але дуже тупий виконавець.
Тому організація даних, представлених для машинної обробки
має бути простою і одноманітною,
навіть якщо з людської точки зору це виглядатиме невкладисто й одороблувато.

Для даних, організованих у таблицю, існує просте залізобетонне правило:
**кожна колонка є змінною, кожен рядок — окремим спостереженням**.
Такі дані називаються «охайними» (tidy), і їх можна легко і швидко трансформувати,
аналізувати і візуалізувати.


> Як і сім’ї, охайні, добре структуровані набори даних всі подібні,
  але кожен неохайний набір --- неохайний по-своєму.
> *Tidy Data by Hadley Wickham*, [vita.had.co.nz/papers/tidy-data.pdf](http://vita.had.co.nz/papers/tidy-data.pdf)


Таблиці, створені про людське око, далекі від дотримання цього правила.
Наприклад, ось таблиця, взята з публікації Держстату:

Table: Доходи населення за регіонами України у 2012-2014 роках, млн грн

Область            2012    2013     2014
----------------  -------  -------  ------
Вінницька         35441    37323    39184
Волинська         19546    20609    21971
Дніпропетровська  95349    99995    109545
Донецька          128767   135362   114135

Ця таблиця непогано показує читачеві динаміку доходів населення,
людині зручно порівнювати цифри за роками і за областями,
вона компактна: одиниці виміру винесено в заголовка.
Але вона малопридатна до машинної обробки.
Наприклад (уявімо, що років і областей більше),
її неможливо сортувати і складно фільтрувати.
Крім того, назву змінної «рік» ніде, крім як в заголовку не вказано.

Та ж таблиця, приведена до охайної форми,
може гірше сприйматися людиною,
зате її можна сортувати і фільтрувати,
в неї легко додати дані за іншими областями і роками.

Table: Доходи населення за регіонами України, млн. грн

Область           Рік    Доходи 
----------------  ----  -------
Вінницька         2012    35441
Вінницька         2013    37323
Вінницька         2014    39184
Волинська         2012    19546
Волинська         2013    20609
Волинська         2014    21971
Дніпропетровська  2012    95349
Дніпропетровська  2013    99995
Дніпропетровська  2014   109545
Донецька          2012   128767
Донецька          2012   135362
Донецька          2012   114135


Проблеми зі структуруванням даних найчастіше виникають через
нерозуміння того, що саме у наборі даних є змінними.
**Строго кажучи, змінними є усе, що може набувати значень,**
як кількісних, так і якісних,
а не лише, те що вимірюється в процесі спостереження.
Змінні, значення яких відомі наперед,
називаються фіксованими
(наприклад, стать переважно може мати лише два значення: «чоловіча» та «жіноча»),
на противагу вимірюваним.

**Варто розташовувати колонки фіксованих змінних на початку таблиці,
а вимірюваних — наприкінці.**

П’ять основних проблем неохайних чи погано структурованих наборів даних:

1.  Заголовки в колонках містять значення, а не назви змінних
2.  Різні змінні записані в одну колонку
3.  Змінні записані як в рядках, так і в колонках
4.  Різні типи блоків спостережень записані в тій самій таблиці
5.  Один блок спостереження записано у кількох / багатьох таблицях

Ще один приклад (дуже) погано структурованих даних може бути таким:

      A         B       C      D       E      F
  --- --------- ------- ------ ------- ------ -------
  1                                           
  2             101     102    103     104    105
  3   Стать     Ч       Ж      Ч       Ч      Ч
  4                                           
  5             101     102    103     104    105
  6   Глюкоза   134.1   120    124.8   83.1   105.2
  7                                           
  8             101     102    103     104    105
  9   Інсулін   0.6     1.18   1.23    1.16   0.73

Ми можемо припустити, що це якісь дані лабораторних чи медичних спостережень,
і очима прочитати дані у таблиці.
Втім, для, скажімо, статистичної обробки цих даних такий спосіб запису
інформації неприйнятний. Охайний набір чи масив даних (dataset) має
виглядати так:

      A     B       C         D
  --- ----- ------- --------- ---------
  1   id    стать   глюкоза   інсулін
  2   101   Ч       134.1     0.6
  3   102   Ж       120       1.18
  4   103   Ч       124.8     1.23
  5   104   Ч       83.1      1.16
  6   105   Ч       105.2     0.73

Правильна структура даних дозволяє аналітику або комп’ютеру легко
виділяти потрібні змінні, оскільки надає стандартний спосіб
структурування набору даних.

> #### Поради щодо охайно структурованих даних (від Карла Бромана): {- .secret-knowledge}
>
> 1.  Будьте послідовними.
>
>    -   Використовуйте послідовні коди для категоріальних змінних.
>    -   Використовуйте один фіксований код для відсутніх значень.
>    -   Використовуйте послідовні назви змінних.
>    -   Ідентифікатори об'єктів мають бути записані відповідно до
>        однієї системи.
>    -   Використовуйте однакову структуру даних в різних файлах.
>    -   Називайте файли за однією системою, і використовуйте
>        її послідовно.
>    -   Використовуйте один загальний формат для всіх дат, переважно
>        РРРР-ММ-ДД, наприклад 2016-06-21.
>    -   Будьте уважними щодо зайвих пробілах всередині комірок (клітинок
>        в таблиці). Порожня клітинка (дані відсутні) відрізняється від
>        начебто порожньої клітинки з пробілами. Тому «Київ» машина
>        сприйматиме інакше, ніж «Київ» (з пробілом), і дані
>        потребуватимуть додаткової очистки (див. «Очищення даних»).
>
> 2.  Найкращий спосіб збереження даних в таблиці ---
      коли у колонках змінні, а в рядках --- об’єкти (спостереження).
      У першому рядку мають міститися назви змінних 
      (не використовуйте більше одного рядка для назв змінних).
>
> 3.  Заповнюйте всі комірки в таблиці, навіть коли дані відсутні ---
      в такому разі варто мати спеціальне кодування для відсутніх даних.
>
> 4.  Вставляйте лише одне значення в комірку. Наприклад, у комірку може
      бути записана вага, наприклад «45 кг». Краще написати просто «45»,
      а одиниці виміру винести в назву колонки, наприклад «вага\_кг».
      А ще краще, назвати колонку «вага», а одиниці виміру винести в окремий
      словник даних.
>
> 5.  Створіть словник даних --- окрему таблицю, в якій пояснювалися би змінні.
      Це буде частиною метаданих --- дані про дані.
      Такий словник може містити:
>
>      -  Точну назву змінної, як це вказано в наборі даних («технічну» назву змінної);
>      -  Більш читабельну назву змінної, що може використовуватися, наприклад, для візуалізації даних;
>      -  Більш розлогий опис змінної;
>      -  Одиниці виміру;
>      -  Очікувані максимальні та мінімальні значення змінних, наприклад.
>
> 6.   Первинні дані не мають містити в комірках таблиці підрахунків чи формул.
>
> 6.   Не використовуйте виділення кольором чи типом шрифта як дані.
      Наприклад, у якійсь таблиці в Excel-і можна виділити рядки різним кольором,
      щоб позначити окремо чоловіків і жінок.
      Так робити не треба, краще створити окрему змінну (колонку),
      і відповідно закодувати кожен рядок.
>
> 6.  Називайте речі (змінні, файли) зрозуміло.
      Це може бути важко, але краще добре подумати, щоб назва була влучна і містка. 
      Як правило, не варто використовувати пробіли в назвах змінних
      (тобто в заголовках колонок у таблицях з даними) або назвах файлів, замість них
      використовуйте дефіси (`-`) чи підкреслення (`_`).
>
> 6.  Регулярно робіть резервні копії ваших даних.
      І зберігайте їх в різних місцях.
>
> 6.  Застосовуйте функцію перевірки даних до клітинок (наприклад в
      Excel-і --- [goo.gl/TFB7vC](http://goo.gl/TFB7vC) ) 
      для уникнення помилок
>
> Джерело: *[kbroman.org/dataorg/*](http://kbroman.org/dataorg/)*

Зберігайте дані у простих текстових форматах (таких як CSV).
Використовуючи кирилицю, чи інші символи, що виходять за межі ASCII («базової латинки»),
будьте дуже уважні щодо кодування, в якому зберігаєте файл з даними.
Всім буде спокійніше, якщо це UTF-8.


### Метадані

Змінні в таблиці набору даних варто називати коротко і чітко.
Всі розшифровки, уточнення а також застосовані одиниці виміру
варто виносити до *словника даних* — окремої таблиці метаданих (даних про дані).
Зрозуміло що і ця таблиця має бути охайно структурованою,
наприклад:

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Колонка     Назва змінної          Категорія       Опис
----------- ---------------------- --------------- -----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 id          Ідентифікатор у базі   Службова        Ідентифікатор підприємця в базі даних. Ціле число.

 name        Ім’я                   Конфіденційна   Ім’я об’єкта. Текст, записується у вигляді «ПРІЗВИЩЕ ІМʼЯ ПО-БАТЬКОВІ»

 sex         Стать                  Демографічна    Стать підприємця. Змінна може набувати значення «Ч» (чоловік) або «Ж» (жінка)

 bdate       Дата народження        Демографічна    Дата народження підприємця. Формат – дата, записується у вигляді РРРР-ММ-ДД

 edu         Освіта                 Демографічна    Рівень освіти підприємця. Записується цілим числом, може набувати таких значень:
                                                    
                                                     - 1 – неповна середня
                                                     - 2 – середня
                                                     - 3 – середня спеціальна
                                                     - 4 – незакінчена вища
                                                     - 5 – вища
                                                     - 6 – вчений ступінь
                                                     - 7 – немає даних (невідомо)

`reg_date`  Рік реєстрації         Економічна      Рік реєстрації підприємця. Формат – дата, записується у вигляді РРРР-ММ-ДД

kved        КВЕД                   Економічна      Код класифікації видів економічної діяльності. Текстова змінна. Наприклад «52.62.0» або «31.09». УВАГА! Якщо КВЕДів у підприємця більше одного, то потрібно записувати кожен додатковий КВЕД окремим рядком (створювати окреме спостереження)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Сюди ж можна перенести всі фіксовані змінні, що мають в межах набору
даних однакове значення.


